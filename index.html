<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTC Match Predictions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #121212;
      --fg: #ffffff;
      --accent-red: #ff4d4d;
      --accent-blue: #4d94ff;
      --accent-yellow: #ffd700;
      --accent-purple: #b366ff;
      --card-bg: #1e1e1e;
      --border: #333;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--fg);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
      text-align: center;
    }

    .info, #eventTitle {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 20px;
      text-align: center;
    }

    input, button {
      padding: 8px 12px;
      margin: 5px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: #222;
      color: var(--fg);
    }

    button {
      background-color: var(--accent-blue);
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #1c6ed2;
    }

    table {
      width: 98%;
      max-width: 1400px;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
    }

    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border);
      font-size: 13px;
    }

    th {
      background-color: #2c2c2c;
      font-weight: 600;
    }

    .red-team {
      color: var(--accent-red);
    }

    .blue-team {
      color: var(--accent-blue);
    }

    .highlighted.red-team {
      background-color: var(--accent-red);
      color: #ffffff;
      font-weight: bold;
    }

    .highlighted.blue-team {
      background-color: var(--accent-blue);
      color: #ffffff;
      font-weight: bold;
    }

    .sample-icon::after {
      content: " ðŸ§ª";
      color: var(--accent-yellow);
    }

    .specimen-icon::after {
      content: " ðŸ§¬";
      color: var(--accent-purple);
    }

    .summary-box {
      background-color: #2c2c2c;
      border: 1px solid var(--border);
      padding: 12px 16px;
      margin-top: 10px;
      border-radius: 8px;
      font-size: 14px;
      color: var(--fg);
      max-width: 800px;
      text-align: center;
    }

    #footer {
      margin-top: 40px;
      font-size: 12px;
      color: #777;
      text-align: center;
    }

    #loading {
      font-size: 14px;
      margin-top: 10px;
      color: #aaa;
    }
  </style>
</head>
<body>

  <h1>FTC Match Predictions</h1>
  <div id="eventTitle" class="info">Enter a valid FTCScout event code to begin.</div>

  <div>
    <input type="text" id="eventCode" placeholder="Enter event code" />
    <input type="number" id="highlightTeam" placeholder="Highlight team #" />
    <button onclick="loadData()">Load Matches</button>
  </div>

  <div id="summary-container"></div>
  <div id="loading"></div>

  <table id="matches">
    <thead>
      <tr>
        <th>Match</th>
        <th>Red 1</th>
        <th>Red 2</th>
        <th>Red Total</th>
        <th>Winner</th>
        <th>Blue Total</th>
        <th>Blue 1</th>
        <th>Blue 2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="footer">Powered by FTCScout API</div>

  <script>
    const MATCH_Q = `
      query($code:String!){
        eventByCode(code:$code,season:2024){
          name
          matches {
            id
            matchNum
            teams { teamNumber station alliance }
          }
        }
      }`;

    const TEAM_Q = `
      query($team:Int!){
        teamByNumber(number:$team){
          name
          statistics(season:2024){
            opr
            autoSamplePoints
            autoSpecimenPoints
            dc
          }
        }
      }`;

    const $ = id => document.getElementById(id);
    const teamStats = {};
    const ranks = [];

    async function fetchGraphQL(query, variables) {
      const res = await fetch("https://api.ftcscout.org/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, variables })
      });
      const json = await res.json();
      if (json.errors) throw new Error(json.errors[0].message);
      return json.data;
    }

    async function getTeamData(team) {
      if (teamStats[team]) return teamStats[team];
      const { teamByNumber } = await fetchGraphQL(TEAM_Q, { team });
      const stats = teamByNumber?.statistics ?? {};
      const total = (stats.opr ?? 0) + (stats.dc ?? 0) + (stats.autoSamplePoints ?? 0) + (stats.autoSpecimenPoints ?? 0);
      const entry = {
        name: teamByNumber?.name || "Unknown",
        total: total,
        dc: stats.dc ?? 0,
        sample: stats.autoSamplePoints ?? 0,
        specimen: stats.autoSpecimenPoints ?? 0
      };
      teamStats[team] = entry;
      return entry;
    }

    function formatMatch(matchNum) {
      return matchNum > 20000 ? `M-${matchNum - 20000}` : `Q-${matchNum}`;
    }

    function pickRandomTeam(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    async function loadData() {
      const code = $("eventCode").value.trim();
      const highlight = parseInt($("highlightTeam").value);
      const tbody = $("matches").querySelector("tbody");
      tbody.innerHTML = "";
      $("summary-container").innerHTML = "";
      $("loading").textContent = "Loading...";

      const { eventByCode } = await fetchGraphQL(MATCH_Q, { code });
      if (!eventByCode) return $("loading").textContent = "Invalid event code.";

      $("eventTitle").textContent = eventByCode.name;

      const results = {};
      let topScore = 0, topTeams = [];
      let matchSum = 0, matchCount = 0;

      for (const m of eventByCode.matches) {
        const matchNum = m.matchNum || m.id;
        const red = m.teams.filter(t => t.alliance === "Red");
        const blue = m.teams.filter(t => t.alliance === "Blue");

        const redStats = await Promise.all(red.map(t => getTeamData(t.teamNumber)));
        const blueStats = await Promise.all(blue.map(t => getTeamData(t.teamNumber)));

        const redTotal = Math.round(redStats.reduce((a, b) => a + b.total, 0));
        const blueTotal = Math.round(blueStats.reduce((a, b) => a + b.total, 0));

        const redSample = pickRandomTeam(red)?.teamNumber;
        const blueSpecimen = pickRandomTeam(blue)?.teamNumber;

        const winner = redTotal > blueTotal ? "Red" : blueTotal > redTotal ? "Blue" : "Tie";

        for (const team of red.concat(blue)) {
          const num = team.teamNumber;
          if (!results[num]) results[num] = { wins: 0, losses: 0, ties: 0, high: 0 };
          const r = results[num];
          const score = team.alliance === "Red" ? redTotal : blueTotal;
          if (score > r.high) r.high = score;
          if (winner === "Tie") r.ties++;
          else if (team.alliance === winner) r.wins++;
          else r.losses++;
        }

        const row = document.createElement("tr");

        const highlightCell = (num, color) => {
          let cls = `${color}-team`;
          if (num === highlight) cls = `highlighted ${color}-team`;
          if (num === redSample) cls += " sample-icon";
          if (num === blueSpecimen) cls += " specimen-icon";
          return `<td class="${cls}">${num}</td>`;
        };

        row.innerHTML = `
          <td>${formatMatch(matchNum)}</td>
          ${highlightCell(red[0]?.teamNumber, "red")}
          ${highlightCell(red[1]?.teamNumber, "red")}
          <td class="red-team">${redTotal}</td>
          <td style="color:${winner === "Red" ? "var(--accent-red)" : winner === "Blue" ? "var(--accent-blue)" : "var(--accent-purple)"}">${winner}</td>
          <td class="blue-team">${blueTotal}</td>
          ${highlightCell(blue[0]?.teamNumber, "blue")}
          ${highlightCell(blue[1]?.teamNumber, "blue")}
        `;
        tbody.appendChild(row);

        if (Math.max(redTotal, blueTotal) > topScore) {
          topScore = Math.max(redTotal, blueTotal);
          topTeams = redTotal > blueTotal ? red : blue;
        }

        matchSum += (redTotal + blueTotal) / 2;
        matchCount++;
      }

      const ranked = Object.entries(results).map(([team, r]) => {
        const games = r.wins + r.losses + r.ties;
        const rp = (2 * r.wins + r.ties) / (games || 1);
        return { team: +team, ...r, rp: rp.toFixed(2) };
      }).sort((a, b) => b.rp - a.rp || b.high - a.high);

      const top = ranked[0];
      const avgScore = (matchSum / matchCount).toFixed(2);

      const summary = $("summary-container");
      summary.innerHTML += `<div class="summary-box">Predicted High Score: ${topScore} (${topTeams.map(t => t.teamNumber).join(" & ")})</div>`;
      summary.innerHTML += `<div class="summary-box">Predicted Average Match Score: ${avgScore}</div>`;
      summary.innerHTML += `<div class="summary-box">Predicted 1st Place: ${top.team} (RP: ${top.rp}, W-L-T: ${top.wins}-${top.losses}-${top.ties}, High Score: ${top.high})</div>`;

      if (highlight && results[highlight]) {
        const place = ranked.findIndex(r => r.team === highlight) + 1;
        const r = results[highlight];
        const rp = ((2 * r.wins + r.ties) / (r.wins + r.losses + r.ties)).toFixed(2);
        summary.innerHTML += `<div class="summary-box">Predicted ${place}${["st","nd","rd"][((place+90)%100-10)%10-1]||"th"} Place: ${highlight} (RP: ${rp}, W-L-T: ${r.wins}-${r.losses}-${r.ties}, High Score: ${r.high})</div>`;
      }

      $("loading").textContent = "";
    }
  </script>
</body>
</html>
