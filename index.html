<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FTC Match Predictor</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://api.ftcscout.org; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline';">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4faff;
      color: #002b45;
      margin: 20px;
      text-align: center;
    }
    h1 {
      font-weight: 600;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #003366;
    }
    button {
      background: #003366;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    .match {
      margin: 20px auto;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      text-align: left;
    }
    .alliance {
      display: flex;
      justify-content: space-between;
      padding: 10px;
    }
    .blue {
      color: #003366;
    }
    .red {
      color: #b30000;
    }
    .icons img {
      height: 20px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>FTC Match Predictor - By 20077</h1>
  <label>Team 1 Blue:</label><input id="team1Blue">
  <label>Team 2 Blue:</label><input id="team2Blue"><br>
  <label>Team 1 Red:</label><input id="team1Red">
  <label>Team 2 Red:</label><input id="team2Red"><br>
  <button onclick="fetchData()">Fetch Data</button>

  <div id="matchResult"></div>

  <script>
    function convertAPIDate2Date(s) {
      return new Date(s);
    }

    function convertOprStats2Array(s) {
      return [
        s.totalPointsNp, s.autoPoints, s.autoSpecimenPoints, s.autoSamplePoints,
        s.dcPoints, s.dcSpecimenPoints, s.dcSamplePoints, s.dcParkPoints
      ];
    }

    class Event {
      constructor(ende, startede, temp) {
        this.date = convertAPIDate2Date(ende);
        this.started = startede;
        [this.tot, this.a, this.aSp, this.aSa, this.d, this.dSp, this.dSa, this.e] = temp;
      }
    }

    class Team {
      constructor(teamNum, event) {
        this.num = teamNum;
        this.tot = event.tot;
        this.aSp = event.aSp;
        this.aSa = event.aSa;
        this.dSp = event.dSp;
        this.dSa = event.dSa;
        this.e = event.e;
      }

      getSampleOrSpecimenIcon() {
        if (this.aSp > this.aSa) return 'images/specimen.png';
        if (this.aSa > this.aSp) return 'images/sample.png';
        return '';
      }
    }

    class Alliance {
      constructor(t1, t2) {
        this.icon1 = t1.getSampleOrSpecimenIcon();
        this.icon2 = t2.getSampleOrSpecimenIcon();
        this.a = 2 * Math.max(t1.aSp, t2.aSp);
        this.d = Math.max(t1.dSp, t2.dSp) + Math.min(t1.dSa, t2.dSa);
        this.e = t1.e + t2.e;
        this.tot = this.a + this.d + this.e;
      }
    }

    async function fetchData() {
      const teams = [
        document.getElementById('team1Blue').value,
        document.getElementById('team2Blue').value,
        document.getElementById('team1Red').value,
        document.getElementById('team2Red').value
      ];

      const teamObjs = await Promise.all(teams.map(async (teamNum) => {
        const res = await fetch('https://api.ftcscout.org/graphql', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: `query {
              teamByNumber(number: ${teamNum}) {
                events(season: 2024) {
                  event { end started }
                  stats {
                    ... on TeamEventStats2024 {
                      opr {
                        totalPointsNp autoPoints autoSpecimenPoints autoSamplePoints
                        dcPoints dcSpecimenPoints dcSamplePoints dcParkPoints
                      }
                    }
                  }
                }
              }
            }`
          })
        });

        const data = await res.json();
        const events = data.data?.teamByNumber?.events || [];
        let latest = new Event("1970-01-01", false, [-1, -1, -1, -1, -1, -1, -1, -1]);
        for (const ev of events) {
          if (!ev.event.started) continue;
          const eDate = convertAPIDate2Date(ev.event.end);
          const opr = ev.stats?.opr;
          if (opr && eDate > latest.date) {
            latest = new Event(ev.event.end, true, convertOprStats2Array(opr));
          }
        }
        return new Team(teamNum, latest);
      }));

      const blue = new Alliance(teamObjs[0], teamObjs[1]);
      const red = new Alliance(teamObjs[2], teamObjs[3]);

      document.getElementById('matchResult').innerHTML = `
        <div class="match">
          <div class="alliance blue">
            <div><strong>Blue Total:</strong> ${blue.tot.toFixed(2)}</div>
            <div class="icons">
              ${blue.icon1 ? `<img src="${blue.icon1}" alt="icon">` : ''}
              ${blue.icon2 ? `<img src="${blue.icon2}" alt="icon">` : ''}
            </div>
          </div>
          <div class="alliance red">
            <div class="icons">
              ${red.icon1 ? `<img src="${red.icon1}" alt="icon">` : ''}
              ${red.icon2 ? `<img src="${red.icon2}" alt="icon">` : ''}
            </div>
            <div><strong>Red Total:</strong> ${red.tot.toFixed(2)}</div>
          </div>
        </div>`;
    }
  </script>
</body>
</html>
