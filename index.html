<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FTC Match Predictions (2024 Detailed Stats)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #121212;
      --fg: #fff;
      --accent-red: #ff4d4d;
      --accent-blue: #4d94ff;
      --accent-yellow: #ffd700;
      --accent-purple: #b366ff;
      --card-bg: #1e1e1e;
      --border: #333;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--fg);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-weight: 700;
      margin-bottom: 5px;
      font-size: 28px;
      text-align: center;
    }
    .info, #eventTitle {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 20px;
      text-align: center;
    }
    input, button {
      padding: 8px 12px;
      margin: 5px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: #222;
      color: var(--fg);
    }
    button {
      background-color: var(--accent-blue);
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #1c6ed2;
    }
    table {
      width: 98%;
      max-width: 1400px;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: var(--card-bg);
      border: 1px solid var(--border);
    }
    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--border);
      font-size: 13px;
    }
    th {
      background-color: #2c2c2c;
      font-weight: 600;
    }
    .red-team {
      color: var(--accent-red);
    }
    .blue-team {
      color: var(--accent-blue);
    }
    .highlighted.red-team {
      background-color: var(--accent-red);
      color: #fff;
      font-weight: bold;
    }
    .highlighted.blue-team {
      background-color: var(--accent-blue);
      color: #fff;
      font-weight: bold;
    }
    .sample-icon::after {
      content: " ðŸ§ª";
      color: var(--accent-yellow);
    }
    .specimen-icon::after {
      content: " ðŸ§¬";
      color: var(--accent-purple);
    }
    .summary-box {
      background-color: #2c2c2c;
      border: 1px solid var(--border);
      padding: 12px 16px;
      margin-top: 10px;
      border-radius: 8px;
      font-size: 14px;
      color: var(--fg);
      max-width: 800px;
      text-align: center;
    }
    #footer {
      margin-top: 40px;
      font-size: 12px;
      color: #777;
      text-align: center;
    }
    #loading {
      font-size: 14px;
      margin-top: 10px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>FTC Match Predictions (2024 Detailed Stats)</h1>
  <div id="eventTitle" class="info">Enter a valid FTCScout event code to begin.</div>
  <div>
    <input type="text" id="eventCode" placeholder="Enter event code (e.g. NJ2024)" />
    <input type="number" id="highlightTeam" placeholder="Highlight team #" />
    <button id="loadBtn">Load Matches</button>
  </div>
  <div id="summary-container"></div>
  <div id="loading"></div>
  <table id="matches">
    <thead>
      <tr>
        <th>Match</th>
        <th>Red 1</th>
        <th>Red 2</th>
        <th>Red Total</th>
        <th>Winner</th>
        <th>Blue Total</th>
        <th>Blue 1</th>
        <th>Blue 2</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="footer">Powered by FTCScout API</div>

  <script>
    const MATCH_Q = `
      query($code:String!) {
        eventByCode(code:$code,season:2024) {
          name
          matches {
            id
            matchNum
            teams {
              teamNumber
              station
              alliance
            }
          }
        }
      }
    `;

    const TEAM_Q = `
      query($team:Int!) {
        teamByNumber(number:$team) {
          events(season:2024) {
            event {
              end
              started
            }
            stats {
              ... on TeamEventStats2024 {
                opr {
                  totalPointsNp
                  autoPoints
                  autoSpecimenPoints
                  autoSamplePoints
                  dcPoints
                  dcSpecimenPoints
                  dcSamplePoints
                  dcParkPoints
                }
              }
            }
          }
        }
      }
    `;

    const $ = id => document.getElementById(id);
    const teamStats = {};
    let results = {};
    let ranked = [];

    async function fetchGraphQL(query, variables) {
      const res = await fetch("https://api.ftcscout.org/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, variables }),
      });
      const json = await res.json();
      if (json.errors) throw new Error(json.errors[0].message);
      return json.data;
    }

    // For each team: get latest event stats (by event end date)
    async function getTeamData(team) {
      if (teamStats[team]) return teamStats[team];
      const { teamByNumber } = await fetchGraphQL(TEAM_Q, { team });
      if (!teamByNumber || !teamByNumber.events.length) {
        // No stats fallback
        const empty = {
          name: `#${team}`,
          total: 0,
          oprPoints: 0,
          autoPoints: 0,
          autoSamplePoints: 0,
          autoSpecimenPoints: 0,
          dcPoints: 0,
          dcSamplePoints: 0,
          dcSpecimenPoints: 0,
          dcParkPoints: 0
        };
        teamStats[team] = empty;
        return empty;
      }
      // Pick latest event (by end date)
      const latestEvent = teamByNumber.events.reduce((latest, ev) => {
        if (!latest) return ev;
        const latestEnd = new Date(latest.event.end || 0);
        const evEnd = new Date(ev.event.end || 0);
        return evEnd > latestEnd ? ev : latest;
      }, null);

      const opr = latestEvent.stats?.opr || {};
      const totalPointsNp = opr.totalPointsNp || 0;
      const autoPoints = opr.autoPoints || 0;
      const autoSamplePoints = opr.autoSamplePoints || 0;
      const autoSpecimenPoints = opr.autoSpecimenPoints || 0;
      const dcPoints = opr.dcPoints || 0;
      const dcSamplePoints = opr.dcSamplePoints || 0;
      const dcSpecimenPoints = opr.dcSpecimenPoints || 0;
      const dcParkPoints = opr.dcParkPoints || 0;

      // Aggregate total points from relevant fields
      const total = totalPointsNp + autoPoints + autoSamplePoints + autoSpecimenPoints + dcPoints + dcSamplePoints + dcSpecimenPoints + dcParkPoints;

      const result = {
        name: teamByNumber.name || `#${team}`,
        total,
        oprPoints: totalPointsNp,
        autoPoints,
        autoSamplePoints,
        autoSpecimenPoints,
        dcPoints,
        dcSamplePoints,
        dcSpecimenPoints,
        dcParkPoints
      };
      teamStats[team] = result;
      return result;
    }

    function formatMatch(matchNum) {
      return matchNum > 20000 ? `M-${matchNum - 20000}` : `Q-${matchNum}`;
    }

    function pickRandomTeam(arr) {
      if (!arr.length) return null;
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function highlightClass(teamNum, color, highlightTeam, sampleTeam, specimenTeam) {
      let cls = `${color}-team`;
      if (teamNum === highlightTeam) cls = `highlighted ${color}-team`;
      if (teamNum === sampleTeam) cls += " sample-icon";
      if (teamNum === specimenTeam) cls += " specimen-icon";
      return cls;
    }

    async function loadData() {
      const code = $("eventCode").value.trim();
      const highlight = parseInt($("highlightTeam").value);
      const tbody = $("matches").querySelector("tbody");
      const summary = $("summary-container");
      tbody.innerHTML = "";
      summary.innerHTML = "";
      $("loading").textContent = "Loading...";

      results = {};
      Object.keys(teamStats).forEach(k => delete teamStats[k]);

      try {
        const { eventByCode } = await fetchGraphQL(MATCH_Q, { code });
        if (!eventByCode) throw new Error("Invalid event code");

        $("eventTitle").textContent = eventByCode.name;

        let topScore = 0, topTeams = [];
        let matchSum = 0, matchCount = 0;

        for (const m of eventByCode.matches) {
          const matchNum = m.matchNum ?? m.id;
          const red = m.teams.filter(t => t.alliance === "Red");
          const blue = m.teams.filter(t => t.alliance === "Blue");

          // Fetch team stats in parallel
          const redStats = await Promise.all(red.map(t => getTeamData(t.teamNumber)));
          const blueStats = await Promise.all(blue.map(t => getTeamData(t.teamNumber)));

          // Sum totals
          const redTotal = Math.round(redStats.reduce((a, b) => a + b.total, 0));
          const blueTotal = Math.round(blueStats.reduce((a, b) => a + b.total, 0));

          // Pick sample & specimen teams randomly per alliance
          const redSample = pickRandomTeam(red)?.teamNumber;
          const blueSpecimen = pickRandomTeam(blue)?.teamNumber;

          const winner = redTotal > blueTotal ? "Red" : blueTotal > redTotal ? "Blue" : "Tie";

          // Update results
          for (const team of red.concat(blue)) {
            const num = team.teamNumber;
            if (!results[num]) results[num] = { wins: 0, losses: 0, ties: 0, high: 0 };
            const r = results[num];
            const score = team.alliance === "Red" ? redTotal : blueTotal;
            if (score > r.high) r.high = score;
            if (winner === "Tie") r.ties++;
            else if (team.alliance === winner) r.wins++;
            else r.losses++;
          }

          // Append row progressively for live update
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatMatch(matchNum)}</td>
            <td class="${highlightClass(red[0]?.teamNumber, 'red', highlight, redSample, blueSpecimen)}">${red[0]?.teamNumber || ''}</td>
            <td class="${highlightClass(red[1]?.teamNumber, 'red', highlight, redSample, blueSpecimen)}">${red[1]?.teamNumber || ''}</td>
            <td class="red-team">${redTotal}</td>
            <td style="color:${winner === "Red" ? "var(--accent-red)" : winner === "Blue" ? "var(--accent-blue)" : "var(--accent-purple)"}">${winner}</td>
            <td class="blue-team">${blueTotal}</td>
            <td class="${highlightClass(blue[0]?.teamNumber, 'blue', highlight, redSample, blueSpecimen)}">${blue[0]?.teamNumber || ''}</td>
            <td class="${highlightClass(blue[1]?.teamNumber, 'blue', highlight, redSample, blueSpecimen)}">${blue[1]?.teamNumber || ''}</td>
          `;
          tbody.appendChild(row);

          if (Math.max(redTotal, blueTotal) > topScore) {
            topScore = Math.max(redTotal, blueTotal);
            topTeams = redTotal > blueTotal ? red : blue;
          }

          matchSum += (redTotal + blueTotal) / 2;
          matchCount++;

          // Small delay so UI updates progressively (optional)
          await new Promise(r => setTimeout(r, 100));
        }

        ranked = Object.entries(results).map(([team, r]) => {
          const games = r.wins + r.losses + r.ties;
          const rp = (2 * r.wins + r.ties) / (games || 1);
          return { team: +team, ...r, rp: rp.toFixed(2) };
        }).sort((a, b) => b.rp - a.rp || b.high - a.high);

        const top = ranked[0];
        const avgScore = (matchSum / matchCount).toFixed(2);

        summary.innerHTML += `<div class="summary-box">Predicted High Score: ${topScore} (${topTeams.map(t => t.teamNumber).join(" & ")})</div>`;
        summary.innerHTML += `<div class="summary-box">Predicted Average Match Score: ${avgScore}</div>`;
        summary.innerHTML += `<div class="summary-box">Predicted 1st Place: ${top.team} (RP: ${top.rp}, W-L-T: ${top.wins}-${top.losses}-${top.ties}, High Score: ${top.high})</div>`;

        if (highlight && results[highlight]) {
          const place = ranked.findIndex(r => r.team === highlight) + 1;
          const r = results[highlight];
          const rp = ((2 * r.wins + r.ties) / (r.wins + r.losses + r.ties)).toFixed(2);
          const suffix = ["th","st","nd","rd"][(place%100>3 && place%100<21)?0:(place%10)] || "th";
          summary.innerHTML += `<div class="summary-box">Predicted ${place}${suffix} Place: ${highlight} (RP: ${rp}, W-L-T: ${r.wins}-${r.losses}-${r.ties}, High Score: ${r.high})</div>`;
        }

        $("loading").textContent = "";
      } catch (e) {
        $("loading").textContent = "Error: " + e.message;
        $("eventTitle").textContent = "Enter a valid FTCScout event code to begin.";
        tbody.innerHTML = "";
        $("summary-container").innerHTML = "";
      }
    }

    $("loadBtn").addEventListener("click", loadData);
  </script>
</body>
</html>
